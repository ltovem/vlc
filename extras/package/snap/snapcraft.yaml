name: vlc
adopt-info: vlc
version: "daily"
grade: stable
base: core22
summary: Read, capture, broadcast your multimedia streams
description: |
  VLC is a free and open source cross-platform multimedia player and
  framework that plays most multimedia files as well as DVDs, Audio CDs,
  VCDs, and various streaming protocols.
  NOTE. This snap contains an untested daily build of VLC
confinement: strict
compression: lzo
plugs:
  desktop:
    mount-host-font-cache: false
  dot-config-aacs:
    interface: personal-files
    read:
    - $HOME/.config/aacs
  #this is usually provided by kde-neon
  icon-themes:
    interface: content
    target: $SNAP/data-dir/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/data-dir/sounds
    default-provider: gtk-common-themes
  gtk-3-themes:
    interface: content
    target: $SNAP/data-dir/themes
    default-provider: gtk-common-themes
hooks:
  configure:
    plugs:
      - desktop
    command-chain:
      - command-chain/hooks-configure-fonts
environment:
  #for snapcraft-desktop-integration, this is usually provided by kde-neon
  SNAP_DESKTOP_RUNTIME: $SNAP
  QT_QPA_PLATFORMTHEME: flatpak
  QT_QPA_FLATPAK_PLATFORMTHEME: kde
apps:
  vlc:
    desktop: vlc.desktop
    command: bin/vlc-snap-wrapper.sh
    command-chain:
      - command-chain/desktop-launch
    #kde-neon is broken right now, see https://github.com/snapcore/snapcraft/issues/4569
    #also it doesn't support qt6,
    #extensions:
    #  - kde-neon
    common-id: org.videolan.vlc
    plugs:
      - unity7
      - network
      - network-bind
      - home
      - opengl
      - alsa
      - pulseaudio
      - mount-observe
      - optical-drive
      - camera
      - removable-media
      - screen-inhibit-control
      - x11
      - wayland
      - desktop
      - desktop-legacy
      - dvb
      - audio-playback
      - audio-record
      - jack1
      - avahi-control
      - dot-config-aacs
    slots:
      - mpris
parts:
  #usually provided by kde-neon
  mesa:
    after: []
    plugin: nil
    build-attributes:
    - no-patchelf
    build-packages: []
    stage-packages:
    - libgl1-mesa-dri
    - libglx-mesa0
    prime:
    - -lib/udev
    - -usr/doc
    - -usr/doc-base
    - -usr/share/applications
    - -usr/share/apport
    - -usr/share/bug
    - -usr/share/doc
    - -usr/share/doc-base
    - -usr/share/icons
    - -usr/share/libdrm
    - -usr/share/libwacom
    - -usr/share/lintian
    - -usr/share/man
    - -usr/share/pkgconfig
  #usually provided by kde-neon
  desktop-hook:
    source: https://github.com/snapcore/snapcraft-desktop-integration.git
    source-type: git
    plugin: make
    make-parameters:
      - -C
      - qt-framework
      #any existing plug, desktop integration usually check that their base snap is present
      #but we don't use one
      - PLATFORM_PLUG=desktop
  vlc:
    after:
      - desktop-hook
    #  - kde-neon
    source: .
    source-type: git
    plugin: autotools
    build-environment:
      # ubuntu core 22 ship Qt6.2.4 which doesn't provide .pc files,
      # use our own for compatibility
      - PKG_CONFIG_PATH: ${PKG_CONFIG_PATH:+$PKG_CONFIG_PATH:}${CRAFT_PROJECT_DIR}/extras/package/snap/qt6-pkg-config/usr/lib/pkgconfig/
    autotools-configure-parameters:
      - --host=${CRAFT_ARCH_TRIPLET_BUILD_FOR}
      - --prefix=/usr
      - --enable-merge-ffmpeg
      - --enable-extra-checks
      - --enable-debug
      - --disable-wayland
    override-pull: |
      craftctl default
      craftctl set version=$(git describe --always HEAD)
    override-build: |
      cd extras/tools
      ./bootstrap
      make -j $(getconf _NPROCESSORS_ONLN)
      cd ../../
      export PATH=$PWD/extras/tools/build/bin:$PATH
      export VLC_CONTRIB_SHA="$(extras/ci/get-contrib-sha.sh)"
      export VLC_PREBUILT_CONTRIBS_URL="https://artifacts.videolan.org/vlc/snap/vlc-contrib-${CRAFT_ARCH_TRIPLET_BUILD_FOR}-${VLC_CONTRIB_SHA}.tar.bz2"
      if ! extras/ci/check-url.sh "$VLC_PREBUILT_CONTRIBS_URL"; then unset VLC_PREBUILT_CONTRIBS_URL; fi
      cd contrib && mkdir linux && cd linux
      ../bootstrap \
          --host=${CRAFT_ARCH_TRIPLET_BUILD_FOR} \
          --enable-libdsm \
          --enable-dvdcss
      if [ -v VLC_PREBUILT_CONTRIBS_URL ]; then
          make prebuilt PREBUILT_URL="$VLC_PREBUILT_CONTRIBS_URL"
          make -j $(getconf _NPROCESSORS_ONLN) tools
      else
          make list
          make -j $(getconf _NPROCESSORS_ONLN) fetch
          make -j $(getconf _NPROCESSORS_ONLN) -k || make -j1
          make package
      fi
      cd ../..
      craftctl default
      cp ${CRAFT_PART_INSTALL}/usr/share/icons/hicolor/256x256/apps/vlc.png ${CRAFT_PART_INSTALL}/vlc.png
      cp ${CRAFT_PART_INSTALL}/usr/share/applications/vlc.desktop ${CRAFT_PART_INSTALL}/vlc.desktop
      sed -i 's/\(^Icon=\).*$/\1\/vlc.png/' ${CRAFT_PART_INSTALL}/vlc.desktop
      sed -i 's|TryExec=.*|TryExec=/snap/bin/vlc|' ${CRAFT_PART_INSTALL}/vlc.desktop
    build-packages:
      - ant
      - git
      - g++
      - make
      - autoconf
      - libtool
      - libtool-bin
      - cmake
      - automake
      - build-essential
      - curl
      - gettext
      - openjdk-11-jdk-headless
      - libxcb-xfixes0-dev
      - libasound2-dev
      - libavahi-client-dev
      - libcdio-dev
      - libdbus-1-dev
      - libdirectfb-dev
      - libdrm-dev
      - libegl1-mesa-dev
      - libfreetype6-dev
      - libfribidi-dev
      - libgbm-dev
      - libgles2-mesa-dev
      - libgnutls28-dev
      - libglib2.0-dev
      - libgtk-3-dev
      - libidn-dev
      - libjack-dev
      - liblircclient-dev
      - liblua5.2-dev
      - libmtp-dev
      - libncursesw5-dev
      - libpng-dev
      - libpulse-dev
      - librsvg2-dev
      - libsecret-1-dev
      - libudev-dev
      - libv4l-dev
      - libva-dev
      - libvdpau-dev
      - libx11-dev
      - libxcb-composite0-dev
      - libxcb-damage0-dev
      - libxcb-keysyms1-dev
      - libxcb-randr0-dev
      - libxcb-shm0-dev
      - libxcb-xv0-dev
      - libxcb1-dev
      - libxext-dev
      - libxi-dev
      - libxinerama-dev
      - libxkbcommon-x11-dev
      - libxml2-dev
      - libxpm-dev
      - libzvbi-dev
      - lua5.2
      - pkg-config
      - xz-utils
      - zlib1g-dev
      - bison
      - flex
      - libvulkan-dev
      - libgcrypt20-dev
      - libsystemd-dev
      - libprotobuf-dev
      - protobuf-compiler
      - wayland-protocols
      # qt6
      # kde_neon-sdk is broken right now and doesn't ship qt6, install dev package
      - qt6-shader-baker
      - libqt6svg6-dev
      - libqt6opengl6-dev
      - libqt6shadertools6-dev
      - qt6-wayland-dev
      - qt6-base-dev
      - qt6-base-private-dev
      - qt6-declarative-dev
      - qt6-declarative-private-dev
      - qml6-module-qttest
      - qml6-module-qt5compat-graphicaleffects
      - qml6-module-qtcore
      - qml6-module-qtqml
      - qml6-module-qtqml-models
      - qml6-module-qtquick
      - qml6-module-qtquick-controls
      - qml6-module-qtquick-layouts
      - qml6-module-qtquick-templates
      - qml6-module-qtquick-window

    stage-packages:
      - fonts-freefont-ttf
      - dbus-x11
      - libegl1-mesa
      - libfreetype6
      - libfribidi0
      - libdb5.3
      - libgcc1
      - libgl1-mesa-glx
      - libgles2-mesa
      - libglib2.0-0
      - libpulse0
      - librsvg2-2
      - libsecret-1-0
      - libva-drm2
      - libva-x11-2
      - libva2
      - libvdpau1
      - libx11-6
      - libxcb-composite0
      - libxcb-damage0
      - libxcb-keysyms1
      - libxcb-randr0
      - libxcb-shm0
      - libxcb-xv0
      - libxcb1
      - libxext6
      - libxi6
      - libxinerama1
      - libxkbcommon-x11-0
      - libxpm4
      - vdpau-driver-all
      - on amd64:
          - i965-va-driver
          - intel-media-va-driver
      - mesa-utils
      - mesa-vdpau-drivers
      - mesa-vulkan-drivers
      - mesa-va-drivers
      - zlib1g
      - libjack0
      - libasound2
      - libgtk-3-0
      - liblua5.2-0
      - libmtp9
      - libzvbi0
      - libnotify4
      - libvulkan1
      - libaacs0
      - libvulkan-dev
      - openjdk-8-jdk
      - libgcrypt20
      - libidn12
      - libxcomposite1
      - libxcursor1
      - libxrandr2
      - libatk1.0-0
      - libva-wayland2
      - libprotobuf23

      # following are usually shiped with kde-neon
      - qt6-wayland
      - qt6-qpa-plugins
      - qml6-module-qt5compat-graphicaleffects
      - qml6-module-qtcore
      - qml6-module-qtqml
      - qml6-module-qtqml-models
      - qml6-module-qtquick
      - qml6-module-qtquick-controls
      - qml6-module-qtquick-layouts
      - qml6-module-qtquick-templates
      - qml6-module-qtquick-window
      - qml6-module-qtqml-workerscript
      - libqt6core6
      - libqt6gui6
      - libqt6widgets6
      - libqt6network6
      - libqt6svg6
      - libqt6qmlmodels6
      - libqt6qmlworkerscript6
      - libqt6quick6
      - libqt6quickcontrols2-6
      - libqt6quicklayouts6
      - libqt6quickparticles6
      - libqt6quickshapes6
      - libqt6quicktemplates2-6
      - libqt6qml6
      - libqt6opengl6
      - libqt6shadertools6
      - qt6-xdgdesktopportal-platformtheme
    prime:
      #excluded
      - "-usr/lib/*/cmake/*"
      - "-usr/include/*"
      - "-usr/share/ECM/*"
      - "-usr/share/doc/*"
      - "-usr/share/man/*"
      - "-usr/share/icons/breeze-dark*"
      - "-usr/bin/X11"
      - "-usr/lib/gcc/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/6.0.0"
      - "-usr/lib/aspell/*"
      - "-usr/share/lintain"

  wrapper:
    plugin: dump
    after: [vlc]
    source: extras/package/snap
    organize:
      vlc-snap-wrapper.sh: bin/vlc-snap-wrapper.sh

  fixup-vulkan-icd-paths:
    plugin: nil
    after: [wrapper]
    override-build: |
      sed -i -E 's,(^.+"library_path": ")/.*/,\1,' ${CRAFT_STAGE}/usr/share/vulkan/icd.d/*.json
